'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.plugin = exports.eventType = undefined;

var _lodash = require('lodash.get');

var _lodash2 = _interopRequireDefault(_lodash);

var _logFromKeys = require('../util/logFromKeys');

var _logFromKeys2 = _interopRequireDefault(_logFromKeys);

var _constants = require('../util/constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* This module supports the "lambda" type integration
   for the serverless framework which provides a
   default custom mapping template.

   The sls mapping template is described here:
   https://serverless.com/framework/docs/providers/aws/events/apigateway/#example-lambda-event-before-customization
 */

var type = 'apiGateway';
var source = 'slsIntegrationLambda';

var keys = ['body', 'method', 'principalId', 'stage'];

var keysThatNeedValues = ['identity.userAgent', 'identity.sourceIp', 'identity.accountId'];

function eventType(event) {
  if (typeof event === 'object') {
    var keysArePresent = keys.every(function (s) {
      return s in event;
    });
    var valuesArePresent = keysThatNeedValues.map(function (k) {
      return typeof (0, _lodash2.default)(event, k) !== 'undefined';
    }).filter(Boolean).length === keysThatNeedValues.length;
    return keysArePresent && valuesArePresent ? source : false;
  }
  return false;
}

var pluginKeyMapping = [['method', 'httpMethod'], ['identity.accountId', 'requestContext.accountId'], ['method', 'requestContext.httpMethod'], ['identity.userAgent', 'requestContext.identity.userAgent'], ['stage', 'requestContext.stage'], 'headers.X-Amz-Cf-Id', 'headers.X-Amzn-Trace-Id'];

function plugin(event, log) {
  (0, _logFromKeys2.default)({ event, type, keys: pluginKeyMapping, log });
  log(`${_constants.pluginName}.eventType.source`, source);
}

exports.eventType = eventType;
exports.plugin = plugin;